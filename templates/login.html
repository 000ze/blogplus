<!DOCTYPE html>
<!-- saved from url=(0046)http://www.jq22.com/demo/jquerySignIn20160720/ -->
<html lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/theme.css" type="text/css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link href="https://cdn.bootcss.com/font-awesome/5.10.0-11/css/all.css" rel="stylesheet">
    <link rel="icon" href="/static/fav.ico">
    <title>欢迎登录</title>
    <link rel="stylesheet" type="text/css" href="/static/styles.css">
    <!--[if IE]>
		<script src="http://libs.baidu.com/html5shiv/3.7/html5shiv.min.js"></script>
	<![endif]-->
    <style>
       .demo{
    border: 0;
    padding: 7px 10px;
    border-radius: 25px;
}
    </style>
</head>
<body id="classic-website" class="mt-main-index one-column"
      style="background-size: cover; background-repeat: no-repeat; background-image: url(/media/planet.jpg)">
<div class="jq22-container" style="padding-top:100px">
    <div class="login-wrap">
        <div class="login-html">
            <input id="tab-1" type="radio" name="tab" class="sign-in" checked=""><label for="tab-1" class="tab">登陆</label>
            <input id="tab-2" type="radio" name="tab" class="sign-up"><label for="tab-2" class="tab">注册</label>
            <div class="login-form">
                <div class="sign-in-htm">

                    <form class="form-horizontal" autocomplete="off" action="/login/"
                          method="post">
                        {% csrf_token %}
                        <div class="group">
                            <label for="username"  class="group">用户:</label>
                            <input name="username" id="username" type="text" class="input">
                        </div>
                        <div class="group">
                            <label for="password"  class="group">密码:</label>
                            <input name="password" id="password" type="password" class="input" data-type="password">
                        </div>

                        <div class="group">
                            <span class="login-error"></span>
                        </div>
                           <div class="form-group">
                        <!-- 放置极验的滑动验证码 -->
                        <div id="popup-captcha"></div>
                    </div>

                        <div class="group">
                            <p class="text-danger text-center">{{ error }} </p>
                        </div>

                        <div class="group">
                            <input id="check" type="checkbox" class="check" checked="">
                            <label for="check"><span class="icon"></span> Remember me</label>
                        </div>
                         <label for="username" class="col-sm-offset-2 col-sm-8 ">
                        <button type="button" class="btn btn-primary btn-block" id="login-button">登录</button>
                    </label>

                        <div class="hr"></div>
                        <div class="foot-lnk">
                            <a href="#">Forgot Password?</a>
                        </div>
                    </form>
                </div>

       <div class="sign-up-htm">
       <div class="container">

        <div id="login_in" class="col-md-4 ">
            <form autocomplete="off" novalidate action="/reg/" method="post" class="form-horizontal reg-form"
                  enctype="multipart/form-data">
                {% csrf_token %}



                <div class="form-group">
                    <label for="{{ form_obj.username.id_for_label }}"
                           class="col-sm-4 control-label">{{ form_obj.username.label }}</label>
                    <div class="col-sm-8">
                        {{ form_obj.username }}
                        <span class="help-block">{{ form_obj.username.errors.0 }}</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form_obj.password.id_for_label }}"
                           class="col-sm-4 control-label">{{ form_obj.password.label }}</label>
                    <div class="col-sm-8">
                        {{ form_obj.password }}
                        <span class="help-block">{{ form_obj.password.errors.0 }}</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form_obj.re_password.id_for_label }}"
                           class="col-sm-4 control-label">{{ form_obj.re_password.label }}</label>
                    <div class="col-sm-8">
                        {{ form_obj.re_password }}
                        <span class="help-block">{{ form_obj.re_password.errors.0 }}</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form_obj.email.id_for_label }}"
                           class="col-sm-4 control-label">{{ form_obj.email.label }}</label>
                    <div class="col-sm-8">
                        {{ form_obj.email }}
                        <span class="help-block">{{ form_obj.email.errors.0 }}</span>
                    </div>
                </div>

                <div class="form-group">
                    <label
                            class="col-sm-4 control-label">头像
                    </label>
                    <div class="col-sm-8">

                        <label for="id_avatar"><img id="avatar-img" src="/static/img/default.png" alt=""></label>
                        <input type="file" name="avatar" id="id_avatar" style="display: none">
                        <input accept="image/*" type="file" name="avatar" id="id_avatar" style="display: none">

                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-4 col-sm-8 ">
                        <button type="button" class="btn btn-success btn-block" id="reg-submit">注册</button>
                    </div>
                </div>
                <div class="hr"></div>
                <div class="foot-lnk">
                     <a href="/login/">Already Member?</a>

                    </div>
            </form>
        </div>
    </div>
</div>
                 </div>
            </div>
</div>

</div>
                   <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="280" height="52"
                            src="//music.163.com/outchain/player?type=2&amp;id=2175282&amp;auto=0&amp;height=32"
                            class="music"
                            style="z-index: 0;right: 0PX;display: block;bottom: 60px;position: fixed;"></iframe>
                    <script src="/static/jquery-3.3.1.js"></script>
                    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
                    <!-- 引入封装了failback的接口--initGeetest -->
                    <script src="http://static.geetest.com/static/tools/gt.js"></script>
                    <script>

                        // 极验 发送登录数据的
                        var handlerPopup = function (captchaObj) {
                            // 成功的回调
                            captchaObj.onSuccess(function () {
                                var validate = captchaObj.getValidate();
                                // 1. 取到用户填写的用户名和密码 -> 取input框的值
                                var username = $("#username").val();
                                var password = $("#password").val();
                                $.ajax({
                                    url: "/login/", // 进行二次验证
                                    type: "post",
                                    dataType: "json",
                                    data: {
                                        username: username,
                                        password: password,
                                        csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                                        geetest_challenge: validate.geetest_challenge,
                                        geetest_validate: validate.geetest_validate,
                                        geetest_seccode: validate.geetest_seccode
                                    },
                                    success: function (data) {
                                        console.log(data);
                                        if (data.status) {
                                            // 有错误，在页面上提示
                                            $(".login-error").text(data.msg);
                                        } else {
                                            // 登陆成功
                                            location.href = data.msg;
                                        }
                                    }
                                });
                            });

                            $("#login-button").click(function () {
                                captchaObj.show();
                            });
                            // 将验证码加到id为captcha的元素里
                            captchaObj.appendTo("#popup-captcha");
                            // 更多接口参考：http://www.geetest.com/install/sections/idx-client-sdk.html
                        };
                        // 当input框获取焦点时将之前的错误清空
                        $("#username,#password").focus(function () {
                            // 将之前的错误清空
                            $(".login-error").text("");
                        });

                        // 验证开始需要向网站主后台获取id，challenge，success（是否启用failback）
                        $.ajax({
                            url: "/pc-geetest/register?t=" + (new Date()).getTime(), // 加随机数防止缓存
                            type: "get",
                            dataType: "json",
                            success: function (data) {
                                // 使用initGeetest接口
                                // 参数1：配置参数
                                // 参数2：回调，回调的第一个参数验证码对象，之后可以使用它做appendTo之类的事件
                                initGeetest({
                                    gt: data.gt,
                                    challenge: data.challenge,
                                    product: "popup", // 产品形式，包括：float，embed，popup。注意只对PC版验证码有效
                                    offline: !data.success // 表示用户后台检测极验服务器是否宕机，一般不需要关注
                                    // 更多配置参数请参见：http://www.geetest.com/install/sections/idx-client-sdk.html#config
                                }, handlerPopup);
                            }
                        })


                        // 找到头像的input标签绑定change事件   值发生变化
                        $("#id_avatar").change(function () {
                            // 1. 创建一个读取文件的对象
                            var fileReader = new FileReader();
                            // 取到当前选中的头像文件
                            // 读取你选中的那个文件
                            fileReader.readAsDataURL(this.files[0]);  // 读取文件是需要时间的
                            fileReader.onload = function () {
                                // 2. 等上一步读完文件之后才 把图片加载到img标签中
                                $("#avatar-img").attr("src", fileReader.result);
                            };
                        });
                        // AJAX提交注册的数据
                        $("#reg-submit").click(function () {
                            // 取到用户填写的注册数据，向后端发送AJAX请求
                            var formData = new FormData();
                            formData.append("username", $("#id_username").val());
                            formData.append("password", $("#id_password").val());
                            formData.append("re_password", $("#id_re_password").val());
                            formData.append("email", $("#id_email").val());
                            formData.append("avatar", $("#id_avatar")[0].files[0]);
                            formData.append("csrfmiddlewaretoken", $("[name='csrfmiddlewaretoken']").val());

                            $.ajax({
                                url: "/reg/",
                                type: "post",
                                processData: false,
                                contentType: false,
                                data: formData,
                                success: function (data) {
                                    if (data.status) {
                                        // 有错误就展示错误
                                        // 将报错信息填写到页面上
                                        // data.msg为一个大字典
                                        $.each(data.msg, function (k, v) {

                                            $("#id_" + k).next("span").text(v[0]).parent().parent().addClass("has-error");
                                        })

                                    } else {
                                        // 没有错误就跳转到指定页面
                                        location.href = data.msg;
                                    }
                                }
                            })
                        });

                        // 将所有的input框绑定获取焦点的事件，将所有的错误信息清空
                        $("form input").focus(function () {
                            $(this).next().text("").parent().parent().removeClass("has-error");
                        })

                        $("#id_username").blur(function () {
                            let username = $(this).val();
                            $.ajax({
                                url: "/is_exist/",
                                type: "get",
                                data: {"username": username},
                                success: function (data) {
                                    if (data.status) {
                                        $("#id_username").next().text(data.msg).parent().parent().addClass("has-error");
                                    }
                                }
                            })
                        })


                    </script>
</body>
</html>